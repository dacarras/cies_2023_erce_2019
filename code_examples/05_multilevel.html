<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>CIES: Intro to ERCE with R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Carrasco, D." />
    <script src="libs/header-attrs-2.20/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/ninjutsu.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="animate.min.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">






class: title-slide, middle, center

background-image: url(img/background_01.jpeg)
background-size: 100%

&lt;img src="./img/blank_space.png" width="2%" height="2%" /&gt;

&lt;br&gt;
&lt;br&gt;

.line_space_08[

## Multilevel Models
### .text_70[
Multilevel models with complex sample design]
]

&lt;br&gt;
&lt;br&gt;


.line_space_01[
.white[

.text_70[Carrasco, D., PhD] .text_40[Centro de Medición MIDE UC, Pontificia Universidad Católica]

.text_70[Cayuman, C., Mg.] .text_40[UNESCO-OREALC]

.text_70[Lopez-Hornickel, N., PhD(c)] .text_40[University of Bath]

.text_70[Sandoval-Hernández, A., PhD] .text_40[University of Bath]

.text_70[Treviño, E., PhD] .text_40[Pontificia Universidad Católica]
]
]


&lt;br&gt;

.line_space_03[
.white[
.text_60[CIES 2023: an LCSE SIG workshop]

.text_60[Washington DC, February 18th, 2023]
]
]

&lt;br&gt;



---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
Multilevel Models
]
]
]
.line_space_01[
Fitting multilevel models onto large scale assessment data, including its complex sample design
]


&lt;br&gt;
&lt;br&gt;

---

background-image: url(img/background_04.jpeg)
background-size: 100%


**Multilevel models**

.pull_l_50_t_070[

- In the following section we will review what alternatives we have to fit multilevel models, that can include the complex sample design from large scale assessment.

  - In particular, we will review how to fit these models with specialized software such as:

      - **Mplus**, **Stata**, and the R library called **WeMix**

  - We will compare the results generated with each of these statistical packages.

  - Finally, we will indicate what aspects to considered when one wants to fit these models, in particular we will focus on:

      - Preparing the survey weights (i.e., disagregagtion of survey weights, or partition of survey weights)

      - The role of the sampling weights

      - The preparation of stratifcation variables

      - The role of the stratification variables

      - Design informativeness

]

--

.pull_r_50_t_070[

For the case of ERCe 2019, all multilevele estimates were produced with **Mplus**, including the stratification informaion in the stimation process, while also including the survey weights in a disaggregated way, re-scaled to the effective sample size (Stapleton, 2013). In Mplus we can implement these settings with following portion of code:

```text

[...]

VARIABLE =
STRATIFICATION = id_s;
CLUSTER  = id_j;
WEIGHT   = wi;
BWEIGHT  = wj;
WTSCALE  = ECLUSTER;
BWTSCALE = SAMPLE;

[...]

```

In general terms, the fitted models used in presentations, national reports, and results reports included:

Null Model (Snijer &amp; Bosker, 2012)

`\(y_{ij} = \alpha + u_{j} + \varepsilon_{ij}\)`

Disaggregated Model (Rights et al, 2019)

`\(y_{ij} = \alpha + \beta_{w} x_{w} + \beta_{b} x _{b} + u_{j} + \varepsilon_{ij}\)`

Means as outcome model (Geiser, 2012)

`\(y_{ij} = \alpha + \delta v_{.j} + u_{j} + \varepsilon_{ij}\)`

The rest of the fitted models are slightly more complex variants of all these previous model specifications, where the socioeconomic scores are included as a covariate as in the disggregated model. In the following, we will review an example which integrates all these models.

]

---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
Results of a multilevelmidel
]
]
]
.line_space_01[
Reproducing presented results
]


&lt;br&gt;
&lt;br&gt;

---
background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50_t_100[


&lt;img src="./files/mlm_paraguay.png" width="100%" /&gt;

]

--

.pull_r_50_t_070[

The `22.51*` estimates is the `\(\delta\)` coefficient of the following model:

`\(y_{ij} = \alpha + \delta v_{.j} + \pi_{w} z_{w} + \pi_{b} z _{b} + u_{j} + \varepsilon_{ij}\)`

This estimate represents the expected difference on math scores between the schools with a higher population density (10 thousdan or more people), and the rest of the schools located in cities or towns with a smaller population density (i.e., rural), among sixth graders from Paraguay, in ERCE 2019.

In the following tables we compare five different fitted models. Among these different alternatives only one reproduces the results we presented in national reports, this is **Model 2**.



```r
================================================================
                   Model 1               Model 2              
----------------------------------------------------------------
W Y&lt;-Z_W           12.69   (1.79) ***     12.51   (2.25) ***    
*B Y&lt;-V_B           11.96   (5.98) *       22.51  (10.39) *
B Y&lt;-Z_B           42.73   (8.74) ***     28.10   (6.91) ***    
B Y&lt;-STRAT_2       27.09   (8.12) **                            
B Y&lt;-STRAT_3       36.99  (11.94) **                            
B Y&lt;-STRAT_4       22.30  (11.54)                               
B Y&lt;-STRAT_5       38.33   (8.40) ***                           
B Y&lt;-STRAT_6       35.57  (33.14)                               
B Y&lt;-STRAT_7       10.38  (36.81)                               
B Y&lt;-Intercepts   637.36   (3.36) ***    655.07   (4.60) ***    
W Y&lt;-&gt;Y          4579.00 (121.29) ***   4490.40 (167.57) ***    
B Y&lt;-&gt;Y          1534.32 (276.14) ***   2480.01 (471.29) ***    
================================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05


=========================================================================================
                   Model 3               Model 4               Model 5
-----------------------------------------------------------------------------------------
W Y&lt;-Z_W           12.51   (2.26) ***     12.51   (2.26) ***     12.51   (2.26) ***      
*B Y&lt;-V_B           20.52   (7.90) **      20.52   (7.90) **      20.52   (7.90) **
B Y&lt;-Z_B           25.99   (9.36) **      25.99   (9.36) **      25.99   (9.36) **       
B Y&lt;-STRAT_2       30.39  (10.46) **      30.39  (10.46) **      30.39  (10.46) **       
B Y&lt;-STRAT_3       53.32  (15.42) **      53.32  (15.42) **      53.32  (15.42) **       
B Y&lt;-STRAT_4       39.95  (12.97) **      39.95  (12.97) **      39.95  (12.97) **       
B Y&lt;-STRAT_5       48.30   (9.77) ***     48.30   (9.77) ***     48.30   (9.77) ***      
B Y&lt;-STRAT_6       33.90  (40.72)         33.90  (40.72)         33.90  (40.72)          
B Y&lt;-STRAT_7      -15.98  (17.46)        -15.98  (17.46)        -15.98  (17.46)          
B Y&lt;-Intercepts   629.46   (4.21) ***    629.46   (4.21) ***    629.46   (4.21) ***      
W Y&lt;-&gt;Y          4492.12 (169.39) ***   4492.12 (169.39) ***   4492.12 (169.39) ***      
B Y&lt;-&gt;Y          2155.03 (452.29) ***   2155.03 (452.29) ***   2155.03 (452.29) ***      
=========================================================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05


Note:
Model 1: without sampling design
Model 2: with sampling design (Mplus wb2)
Model 3: including strata as fixed effects (Mplus wb2)
Model 4: including strata as fixed effects (wb2), effective sample size
Model 5: including strata as fixed effects (wa2), normalized weights
```

Let's review the main differences between these different methods with these results.


]


---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
Multilevel model results
]
]
]
.line_space_01[
Comparing estimates with and without sampling design
]


&lt;br&gt;
&lt;br&gt;

---
background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50_t_100[

**Comparison 1**: Math achievement in sixth grade, conditioned by socioeconomic scores (z_w, z_b), and by population density around the schools (10 thousand peopple or more) (v_b) ( ERCE 2019, Paraguay)



```r
================================================================
                   Model 1               Model 2              
----------------------------------------------------------------
W Y&lt;-Z_W           12.69   (1.79) ***     12.51   (2.25) ***    
*B Y&lt;-V_B           11.96   (5.98) *       22.51  (10.39) *
B Y&lt;-Z_B           42.73   (8.74) ***     28.10   (6.91) ***    
B Y&lt;-STRAT_2       27.09   (8.12) **                            
B Y&lt;-STRAT_3       36.99  (11.94) **                            
B Y&lt;-STRAT_4       22.30  (11.54)                               
B Y&lt;-STRAT_5       38.33   (8.40) ***                           
B Y&lt;-STRAT_6       35.57  (33.14)                               
B Y&lt;-STRAT_7       10.38  (36.81)                               
B Y&lt;-Intercepts   637.36   (3.36) ***    655.07   (4.60) ***    
W Y&lt;-&gt;Y          4579.00 (121.29) ***   4490.40 (167.57) ***    
B Y&lt;-&gt;Y          1534.32 (276.14) ***   2480.01 (471.29) ***    
================================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05


Note:
Model 1: without samplin design
Model 2: with sampling design (Mplus wb2)
```

]

--

.pull_r_50_t_070[

The largest difference across the compared models is between models 1 and 2.

**Model 1** conditions math scores by the socioeconomic index of student families and by the population density arround the schools (10 thousand people or more). In this model, we are including the socioeconomic index scores as disaggregated variables. As such, we are partitioning the socioeconomic scores into its within school, and between school variability parts.

**Model 2**, is structurally equivalent to model 1. However, model 2 is including survey weights for observation whithin schools, and and surbey weights between schools. While, at the same time, is including information of the stratification design.

- The main source of difference between these two models, is the incusing of survey weights. These are included as orthogonal components, as survey weights for students within schools, and as survey weights between schools. Out of these two components, survey school weight are the most **informative**. The school survey weights **relocate** the school observations, and have a noticeable effect onto point estimes of between school effects.

- The second aspects that explain differences between these two models, is the inclusion of **strata** variables in the estimates. The effect of the inclusion of the stratification information is less obvious. It has consequences for standard errors estimation, but no effect on point estimates (it shouldn't) (Heeringa et al., 2009). Not including stratification information into estimations, leads to larger standard errors.

**In summary**, ignoring the sampling design as a whole, has non ignorable consequence onto the generated resylatds. Specially, among school factors, where the samlping design is most informative.

In the following we will review how **Model 2** estimates changes if we ignore the stratification variables.


]


---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
Multilevel Model results
]
]
]
.line_space_01[
Comparing estimates with and without stratification information
]


&lt;br&gt;
&lt;br&gt;

---

background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50[

**Comparison 2**: Math achievement results of sixth graders, conditioned by students families socioeconomic status (z_w, z_b), and by population density arround the schools (10 thousand people or more) (v_b) ( ERCE 2019, Paraguay)


```r
=============================================================
                   Modelo 2                Modelo 2b
-------------------------------------------------------------
W Y&lt;-Z_W           12.51   (2.25) ***      12.51   (2.26) ***
B Y&lt;-V_B           22.51  (10.39) *        22.51  (10.52) *  
*B Y&lt;-Z_B           28.10   (6.91) ***      28.10   (7.04) ***
B Y&lt;-Intercepts   655.07   (4.60) ***     655.07   (4.78) ***
W Y&lt;-&gt;Y          4490.40 (167.57) ***    4490.40 (168.40) ***
B Y&lt;-&gt;Y          2480.01 (471.29) ***    2480.01 (471.79) ***
=============================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05


Not:
Model 2: with sampling design (Mplus wb2)
Model 2b: withi sampling design (Mplus wb2), yet ignoring stratification variables
```


```r
=============================================================
                   Wemix                   Stata
-------------------------------------------------------------
W Y&lt;-Z_W           12.51   (2.26) ***      12.51   (2.26) ***
B Y&lt;-V_B           22.48  (10.55) *        22.48  (10.55) *  
*B Y&lt;-Z_B           28.12   (7.00) ***      28.10   (7.00) ***
B Y&lt;-Intercepts   655.07   (4.78) ***     655.07   (4.78) ***

=============================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05

Nota:
Wemix: with survey weights (wb2), yet ignoring stratification variables
Stata: with survey weights (wb2), yet ignoring stratification variables
```

.text_70[In essence, all estimates that **ignore the stratification variables produce larger standard errors**. For example, the standard errors of the **Y&lt;-Z_B** term, are of 1.88% larger, when ignoring stratification variables].


]

--

.pull_r_50_t_090[

As a general rule, ignoring the stratification of the sampling design generates larger standard errors for estimated results (Heeringa et al., 2009; Stapleton 2006, 2008).

If we compare the results generated with `WeMix` and `Stata`, the generated results are equivalent, and very similar to those generated with **Mplus**. Their difference is only of .02 on point estimates for the highlighted coefficient ( `\(\delta\)` = 22.51, SE = 2.25, p &lt; .05 ).

`Mplus` is one of the few statistical packages programmed to include the stratfication information in its estimation process. Whereas, `Wemix` and `Stata` doesn't posses an argument where the stratification information can be included in the estimation process.

In this latter scenario, an option is to include the stratification variables are fixed effects (see Wes et al., 2014, p54). That is, to include each stratification value as a recoded dmmy variable.

En the following slides we will compare the results obtained with Mplus, Wemix, and Stata using this latter recommendation: including stratification information as fixed effects in the model.

]


---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
Multilevel model results
]
]
]
.line_space_01[
Comparing estimates generated while including stratification information through fixed effects
]


&lt;br&gt;
&lt;br&gt;

---

background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50[

**Comparison 3**: Math achievement results of sixth graders, conditioned by students families socioeconomic status (z_w, z_b), and by population density arround the schools (10 thousand people or more) (v_b) ( ERCE 2019, Paraguay)


```r
====================================================================
                   Modelo 2                Modelo 2c
--------------------------------------------------------------------
W Y&lt;-Z_W           12.51   (2.25) ***      12.51   (2.26) ***       
B Y&lt;-V_B           22.51  (10.39) *        20.52   (7.90) **        
B Y&lt;-Z_B           28.10   (6.91) ***      25.99   (9.36) **        
B Y&lt;-Intercepts   655.07   (4.60) ***     629.46   (4.21) ***       
W Y&lt;-&gt;Y          4490.40 (167.57) ***    4492.12 (169.39) ***       
B Y&lt;-&gt;Y          2480.01 (471.29) ***    2155.03 (452.29) ***       
B Y&lt;-STRAT_2                               30.39  (10.46) **        
B Y&lt;-STRAT_3                               53.32  (15.42) **        
B Y&lt;-STRAT_4                               39.95  (12.97) **        
B Y&lt;-STRAT_5                               48.30   (9.77) ***       
B Y&lt;-STRAT_6                               33.90  (40.72)           
B Y&lt;-STRAT_7                              -15.98  (17.46)           
====================================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05

Note:
Model 2: with sampling design (Mplus wb2)
Model 2c: within sampling deisgn (Mplus wb2), and stratification variables as fixed effects
```


```r
=============================================================
                   Wemix                   Stata
-------------------------------------------------------------
W Y&lt;-Z_W           12.51   (2.26) ***      12.51   (2.26) ***
B Y&lt;-V_B           20.51   (7.91) *        20.51   (7.91) *  
B Y&lt;-Z_B           26.01   (9.33) ***      26.01   (9.33) ***
B Y&lt;-Intercepts   629.47   (4.20) ***     629.47   (4.20) ***

=============================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05


Note:
Wemix: with survey weights (wb2), strata as fixed effects
Stata: with survey weights (wb2), strata as fixed effects
```



]

--

.pull_r_50[

If we incude the stratification variables as fixed effects, we will obtained smaller standard errors for the coefficient of interest ( v_b )

- (Mplus) without strata estratos V_B = 22.51, SE = 10.52
- (Mplus) with strata V_B = 22.52, SE = 7.90
- (WeMix, Stata) with strata V_B = 20.51, SE = 7.91


```r
=============================================================
                   Model 2                Model  2b
-------------------------------------------------------------
W Y&lt;-Z_W           12.51   (2.25) ***      12.51   (2.26) ***
B Y&lt;-V_B           22.51  (10.39) *        22.51  (10.52) *  
B Y&lt;-Z_B           28.10   (6.91) ***      28.10   (7.04) ***
B Y&lt;-Intercepts   655.07   (4.60) ***     655.07   (4.78) ***
W Y&lt;-&gt;Y          4490.40 (167.57) ***    4490.40 (168.40) ***
B Y&lt;-&gt;Y          2480.01 (471.29) ***    2480.01 (471.79) ***
=============================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05


Note:
Model 2: with sampling design (Mplus wb2)
Model 2b: with sampling design (Mplus wb2), without stratification
```


```r
=============================================================
                   Wemix                   Stata
-------------------------------------------------------------
W Y&lt;-Z_W           12.51   (2.26) ***      12.51   (2.26) ***
B Y&lt;-V_B           22.48  (10.55) *        22.48  (10.55) *  
B Y&lt;-Z_B           28.12   (7.00) ***      28.12   (7.00) ***
B Y&lt;-Intercepts   655.07   (4.78) ***     655.07   (4.78) ***

=============================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05


Note:
Wemix: with survey weights (wb2), without stratification
Stata: with survey weights (wb2), without stratification
```

]


---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
Fitting multilevel models
]
]
]
.line_space_01[
What considerations should we have to generate mixed model estimates with ERCE 2019
]


&lt;br&gt;
&lt;br&gt;

---

background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50[

**Comparison 3**: Math achievement results of sixth graders, conditioned by students families socioeconomic status (z_w, z_b), and by population density arround the schools (10 thousand people or more) (v_b) ( ERCE 2019, Paraguay)


```r
====================================================================
                   Model 2                Model 2c
--------------------------------------------------------------------
W Y&lt;-Z_W           12.51   (2.25) ***      12.51   (2.26) ***       
B Y&lt;-V_B           22.51  (10.39) *        20.52   (7.90) **        
B Y&lt;-Z_B           28.10   (6.91) ***      25.99   (9.36) **        
B Y&lt;-Intercepts   655.07   (4.60) ***     629.46   (4.21) ***       
W Y&lt;-&gt;Y          4490.40 (167.57) ***    4492.12 (169.39) ***       
B Y&lt;-&gt;Y          2480.01 (471.29) ***    2155.03 (452.29) ***       
B Y&lt;-STRAT_2                               30.39  (10.46) **        
B Y&lt;-STRAT_3                               53.32  (15.42) **        
B Y&lt;-STRAT_4                               39.95  (12.97) **        
B Y&lt;-STRAT_5                               48.30   (9.77) ***       
B Y&lt;-STRAT_6                               33.90  (40.72)           
B Y&lt;-STRAT_7                              -15.98  (17.46)           
====================================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05

Note:
Model 2: with sampling design (Mplus wb2)
Model 2c: with sampling design (Mplus wb2), estratification as fixed effects
```


```r
=============================================================
                   Wemix                   Stata
-------------------------------------------------------------
W Y&lt;-Z_W           12.51   (2.26) ***      12.51   (2.26) ***
B Y&lt;-V_B           20.51   (7.91) *        20.51   (7.91) *  
B Y&lt;-Z_B           26.01   (9.33) ***      26.01   (9.33) ***
B Y&lt;-Intercepts   629.47   (4.20) ***     629.47   (4.20) ***

=============================================================
 *** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05


Note:
Wemix: with survey weights (wb2), stratfication as fixed effects
Stata: with survey weights (wb2), stratfication as fixed effects
```



]

--

.pull_r_50_t_070[

To replicate the results produced in presentations, national reportes, and reuslts reports of ERCE 2019, we need to considered the following aspects:

- To fit the specified model (e.g., variable centering, variables recodification)

  - On this regard, the centering of variables is key.

- include the sampling design information within process of estimation

  - As we jhave review, this implies de use of disaggregated survey weights, and scale survey weigths to the effective sample size

- to obtained the same results, we need to use the sample software used in each report.

  - WeMix and Stata genrate the same results

  - Mplus, Wemix, amd Stata produced results with negligible differences that lead to the same conclusions, yet the results may not be exactly equal. 
  
  - In an scenario were Mplus is difficult to get, WeMix and Stata might be viable options.

  - The inclusion of stratication information as fixed effects is a reasonable option to produce results.

  - However, we need to mindful regarding the interpretation of the intercept, if we included estratification variables as simple recoded dummy variables.

    - If we want to keep the interpretation of the intercept, as the center of all school means, we ay need to create dummy variables for the stratification variables, and center these dummy variables. In this way, the fitted model can keep the intercept term as the center of the distribution of all school means.
]


---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
Preparing the R environment
]
]
]
.line_space_01[
What libraries we need to fit mixed models
]


&lt;br&gt;
&lt;br&gt;

---

background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50_t_080[

**Libraries in use**

- On the right side of the present slide, we include a set of the R libraries we are using for the present session.

- The R library `erce` provides us with ERCE 2019 data, and also includes a series of functions useful for large scale assessment data analysis. Some of these auxiliary functions are:

  - `remove_labels()` we use this command to remove the meta-data for the public data files.

  - `combine_reg()` we use this command to format the output of linear regressions

  - `combine_log()` we use this command to format the output of logistic regressions

- To fit multilevel models, we have the following auxiliary functions:

  - `c_mean()` we use this function to create aggregation of scores at the cluster level, as a cluster mean.

  - `center_variables()` generate a series of vectors (i.e., new variables), including the terms for centering within cluster, and grand mean centering (see Enders et al., 2007). 

  - `lsa_weights()` is a comand that helps ups to get survey weights for multilevel models.


]


--


.pull_r_50_t_100[


```r
# -------------------------------------------------------------------
# libraries
# -------------------------------------------------------------------

#------------------------------------------------
# library to install libraries from github
#------------------------------------------------

install.packages('devtools')

#------------------------------------------------
# library with ERCE data
#------------------------------------------------

# library is in development
devtools::install_github('dacarras/erce',force = TRUE)

#------------------------------------------------
# libraries we have been usoibg
#------------------------------------------------

install.packages('tidyverse')
install.packages('mitools')
install.packages('survey')
install.packages('srvyr')

#------------------------------------------------
# libraries to fit models
#------------------------------------------------

install.packages('MplusAutomation') # requires Mplus
install.packages('RStata')          # requires Stata
install.packages('WeMix')

#------------------------------------------------
# to extract estimates
#------------------------------------------------

install.packages('texreg')
install.packages('miceadds')
```

]

---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
Mplus
]
]
]
.line_space_01[
Fitting multilevel models to reproduce results generated in ERCE 2019 reports
]


&lt;br&gt;
&lt;br&gt;

---

background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50_t_100[


```r
DATA:
FILE = "mlm.dat";
TYPE = IMPUTATION;
 
VARIABLE:
NAMES = id_s id_j wi wj z_w z_b v_b y; 
 MISSING=.;
 
*STRATIFICATION = id_s;
CLUSTER  = id_j;
WEIGHT   = wi;
BWEIGHT  = wj;
*WTSCALE  = ECLUSTER;
*BWTSCALE = SAMPLE;

USEVARIABLES =
y
z_w
v_b
z_b
;

WITHIN  = z_w;
BETWEEN = v_b z_b;


ANALYSIS:

TYPE = COMPLEX TWOLEVEL;
ESTIMATOR = MLR;
PROCESSORS = 4;

MODEL:

%WITHIN%

y on z_w;

%BETWEEN%

y on v_b;
y on z_b;


OUTPUT:

STANDARDIZED
CINTERVAL
RESIDUAL
;
```

]


--


.pull_r_50_t_070[


**Mplus code**

- On the left side of the following slide, we have an example of an Mplus code used to generate the reported results of Paraguay.

- The highlighted lines are the arguments included to scale the conditional survey weigts.

  - `wj` are the school survey weights

  - `wi` are the stduents within school weights

  - Both survey weights are builtin such way that their product is the total survey weight of an observation. As such, we can formally express: `wt = wj * wi`.

- So Mplus can generate the estimates from the different plausible values, we need to create as mant data frames as plausible variables there are (i.e., how many imputations). In the case of ERCE 2019, we need to create 5 different data frames, and create a list of these data files. In the presente example, we are includind the list of imputaions in the `mlm.dat`. file:

```
mlm_imp_1.dat
mlm_imp_2.dat
mlm_imp_3.dat
mlm_imp_4.dat
mlm_imp_5.dat
```

- In each of these data frames, we aree including a column name `y`, that contains the differente plausible values of the variable of interest, for exmaple the test math scores.

- In the repository of the present workshop, we include code R examples that covers this full routine using R and Mplus (see Code 1.4, in `05_multilevel_codes.rmd`.).


]

---

background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50_t_060[


```r
# [...]

# -------------------------------------------------------------------
# multilevel model with Mplus
# -------------------------------------------------------------------

#------------------------------------------------
# create data for Mplus
#------------------------------------------------

data_mixed &lt;- data_model %&gt;%
              dplyr::filter(ctry_name == 'Paraguay') %&gt;%
              rename_all(tolower) %&gt;%
              dplyr::select(
              mat_1, mat_2, mat_3, mat_4, mat_5,
              id_k, id_s, id_j, id_i,
              wb1, wb2, wi, wj,
              z_w, z_b, v_b
              )

#------------------------------------------------
# create list of imputed data
#------------------------------------------------

data_1 &lt;- data_mixed %&gt;% mutate(y = mat_1)
data_2 &lt;- data_mixed %&gt;% mutate(y = mat_2)
data_3 &lt;- data_mixed %&gt;% mutate(y = mat_3)
data_4 &lt;- data_mixed %&gt;% mutate(y = mat_4)
data_5 &lt;- data_mixed %&gt;% mutate(y = mat_5)

data_list &lt;- list(
data_1,
data_2,
data_3,
data_4,
data_5
)

#------------------------------------------------
# create Mplus object
#------------------------------------------------

mplus_model &lt;- MplusAutomation::mplusObject(
MODEL = '
%WITHIN%

y on z_w;

%BETWEEN%

y on v_b;
y on z_b;

',
ANALYSIS = '
TYPE = COMPLEX TWOLEVEL;
ESTIMATOR = MLR;
PROCESSORS = 4;
',
VARIABLE ='
STRATIFICATION = id_s;
CLUSTER  = id_j;
WEIGHT   = wi;
BWEIGHT  = wj;
WTSCALE  = ECLUSTER;
BWTSCALE = SAMPLE;

USEVARIABLES =
y
z_w
v_b
z_b
;

WITHIN  = z_w;
BETWEEN = v_b z_b;

',
OUTPUT ='
STANDARDIZED
CINTERVAL
RESIDUAL
;
',
rdata = data_list,
imputed = TRUE
)
```

]


.pull_r_50_t_060[



```r
# [...]

#------------------------------------------------
# list of data
#------------------------------------------------


mlm_model_data_list &lt;-
'
mlm_imp_1.dat
mlm_imp_2.dat
mlm_imp_3.dat
mlm_imp_4.dat
mlm_imp_5.dat
'

write(mlm_model_data_list, file="mlm.dat", ncolumns=1)

#------------------------------------------------
# fit models
#------------------------------------------------

fit_4 &lt;- MplusAutomation::mplusModeler(mplus_model,
             modelout = 'mlm.inp',
             dataout = 'mlm.dat',
             run = 1L,
             hashfilename = FALSE,
             writeData = 'always'
             )

#------------------------------------------------
# extract estimates
#------------------------------------------------


ci_00  &lt;- fit_4 %&gt;%
          purrr::pluck('results') %&gt;%
          purrr::pluck('parameters') %&gt;%
          purrr::pluck('ci.unstandardized') %&gt;%
          tibble::tibble() %&gt;%
          mutate(term = param)  %&gt;%
          mutate(level  = tolower(BetweenWithin)) %&gt;%
          mutate(ll   = low2.5) %&gt;%
          mutate(ul   = up2.5)  %&gt;%
          mutate(index = paste0(paramHeader, "_", term,"_",level)) %&gt;%
          dplyr::select(index, ll, ul)

r2_00  &lt;- fit_4 %&gt;%
          purrr::pluck('results') %&gt;%
          purrr::pluck('parameters') %&gt;%
          purrr::pluck('r2') %&gt;%
          tibble::tibble() %&gt;%
          mutate(level  = tolower(BetweenWithin)) %&gt;%
          mutate(term = c('r2_w', 'r2_b')) %&gt;%
          mutate(object = c('r2', 'r2')) %&gt;%
          mutate(e  = as.numeric(est)) %&gt;%
          mutate(se = as.numeric(se)) %&gt;%
          mutate(p  = as.numeric(pval)) %&gt;%
          mutate(missing  = as.numeric(rate_missing)) %&gt;%
          mutate(index = paste0(term,"_",level)) %&gt;%
          mutate(control = 'yes') %&gt;%
          dplyr::select(index, level, object, term, e, se, p, missing, control)

tabla_1_4 &lt;- fit_4 %&gt;%
             purrr::pluck('results') %&gt;%
             purrr::pluck('parameters') %&gt;%
             purrr::pluck('unstandardized') %&gt;%
             tibble::tibble() %&gt;%
             mutate(term = param) %&gt;%
             mutate(level  = tolower(BetweenWithin)) %&gt;%
             mutate(e  = est) %&gt;%
             mutate(se = se) %&gt;%
             mutate(p  = pval) %&gt;%
             mutate(missing  = rate_missing) %&gt;%
             mutate(index = paste0(paramHeader, "_", term,"_",level)) %&gt;%
             dplyr::left_join(., ci_00, by = 'index') %&gt;%
             mutate(control = 'yes') %&gt;%
             mutate(object = c(           'pi_w', 'epsilon', 
                               'gamma_b', 'pi_b', 'alpha', 'mu')) %&gt;%
             dplyr::bind_rows(., r2_00) %&gt;%
             dplyr::select(level, object, term, e, se, p, missing, ll, ul, control)

#------------------------------------------------
# display table
#------------------------------------------------

tabla_1_4 %&gt;%
knitr::kable(., digits = 2)
```


]

---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
WeMix
]
]
]
.line_space_01[
How fit a multilevel model using WeMix onto ERCE 2019
]


&lt;br&gt;
&lt;br&gt;

---

background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50_t_070[


```r
# -------------------------------------------------------------------
# multilevel model with WeMix
# -------------------------------------------------------------------

#------------------------------------------------
# setting console app
#------------------------------------------------

options(scipen = 999)
options(digits = 4)

#------------------------------------------------
# data frame
#------------------------------------------------

data_wemix &lt;- data_model %&gt;%
              dplyr::filter(ctry_name == 'Paraguay')

#------------------------------------------------
# fit model
#------------------------------------------------

wemix_pv_results &lt;- mitools::withPV(
   mapping = mat ~ MAT_1 + MAT_2 + MAT_3 + MAT_4 + MAT_5, 
   data = data_wemix,
   action = quote(
*WeMix::mix(
* mat ~ 1 + z_w + z_b + v_b + as.factor(id_s) + (1 | id_j),
* data = data_wemix,
* weights = c('wb1','wb2'),
* cWeights = TRUE)
    ),
   rewrite=TRUE
   )


#------------------------------------------------
# extract estimates
#------------------------------------------------

tabla_1_6 &lt;- summary(
  miceadds::pool_mi(
  qhat = list(
    wemix_pv_results[[1]]$coef,
    wemix_pv_results[[2]]$coef,
    wemix_pv_results[[3]]$coef,
    wemix_pv_results[[4]]$coef,
    wemix_pv_results[[5]]$coef
    ), 
  se   = list(
    wemix_pv_results[[1]]$SE,
    wemix_pv_results[[2]]$SE,
    wemix_pv_results[[3]]$SE,
    wemix_pv_results[[4]]$SE,
    wemix_pv_results[[5]]$SE
    )
  )
) %&gt;%
tibble::rownames_to_column("term") %&gt;%
tibble::as_tibble()

#------------------------------------------------
# display table
#------------------------------------------------

tabla_1_6 %&gt;%
knitr::kable(., digits = 2)
```

]


--


.pull_r_50_t_070[


**WeMix code**

- On life side we are including code to fit a multilevel model, with sampling design in the R library, `WeMix`.

- To fit a multilevel model including plausible values, we use the command `mitools::withPV()`, that we haven shown in previous examples.

- One aspect to bear in min, is that estimation times of the WeMix libary are larger than other libreries. The times are larger for WeMix than for Mplus and Stata for the same data, and same model. Thus, one need to include this extra time in its time planning if we need to fit many models.

- An additional aspect consider, is that the product of results, generated with `withPV()` is a list of *outputs.* These several outputs need to be processed in a certain maner to get the combined estimates. In this example, we are obataining the combined estimates through the function `miceadds::pool_mi()`

- To get more detailes regarding this latter library, se Bailey et al. (2019).

- To check the code in detail, we can check **code 1.6** in `05_multilevel_codes.rmd` and `05_multilevel_codes.html`.



]

---

background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50_t_100[

```text

  * ===============================================.
  * define folder and open data
  * ===============================================.
  
  cd "/Users/d/"
  use "erce_paraguay_a6.dta"
  
  * ===============================.
  * fit mlm model with @pv
  * ===============================.
  
  pv, pv(MAT_1 MAT_2 MAT_3 MAT_4 MAT_5): ///
  mixed @pv               ///
  z_w                     ///
  z_b                     ///
  v_b                     ///
  i.id_s                  ///
  [pw=wb1] || id_j:, ml pweight(wb2)
  estimates store m01
  
  * ===============================.
  * variance
  * ===============================.
  
  /*return residual variance */
  _diparm lnsig_e,  f(exp(@)^2) d(2*exp(@)^2)    
  /*return between  variance */
  _diparm lns1_1_1, f(exp(@)^2) d(2*exp(@)^2)  
  
  * ===============================.
  * estimates
  * ===============================.
  
  esttab m01, b(%9.2f) se(%9.2f) wide transform(ln*: exp(2*@) exp(2*@))

```

]


--


.pull_r_50_t_070[


**Stata code**


- On the left side we have an example of `Stata` code, to fit a multilevel model.

- To fit a fit model including plausible values, we use the function `pv, pv():` from the Stata packagec `pv`. This function is very similar to *withPV()*, one need to include the plausible values variables names within the function argument, and the function generates the estimates per value, and combine these.

  - To install this library in Stata, one can use the following command`ssc install pv`

- To fit a multilevel model within the *pv* function, we use the `mixed` command. Within this latter function we can include the partitioned and scale survey weights, in the code line `[pw=wb1] || id_j:, ml pweight(wb2)`. In this case we are using the scaled survey weights, to the effective sample size.

  - The *common cluster* variable `id_j` is the unique id value per school, we are using here to obtained the random intercept of interest.

  - `ml` is setting the estimator, in this case the estimator is *maximum likelihood*

- By default, *pv* generate the estimates per plausible and generate the combined estimates following the Rubin-Schafer rules.

- As we have seen before the results generated with Stata and WeMix are very similar.

- To check the code in detail, we can check **code 1.7** in `05_multilevel_codes.rmd` and `05_multilevel_codes.html`.

]

---


class: middle, inverse

background-image: url(img/background_02.jpeg)
background-size: 100%


.line_space_01[
Workshop
]
.line_space_01[
.text_250[
.bold_white[
Preparing survey weights
]
]
]
.line_space_01[
How to scale survey weights to fit multilevel models with complex sample design
]


&lt;br&gt;
&lt;br&gt;

---

background-image: url(img/background_04.jpeg)
background-size: 100%

.pull_l_50_t_080[

**Scaling survey weights in multilevel models**


- To create survey weight for students and schools, we rely on the following equivalence:

`$$w_{ij} = w_{j} + w_{i|j}$$`

- This previous equivalence means the total survey weight of an observation `\(w_{ij}\)`, can be decomposed into the cluster weight, or school weight `\(w_{j}\)`, and the relative weight of the within cluster observation, or weight of the student within school `\(w_{i|j}\)`.

- In the case of ERCE 2019 of ERCE these weights are included in the public data file, in the following variables: 

    - WT = `\(w_{ij}\)` total survey weight of the student

    - WJ = `\(w_{j}\)` school survey weight

    - WI = `\(w_{i|j}\)` student within school survey weight

- Once we have identified the previous componentes in the public data file, we need to create the **generic common clustering variables** (i.e., `id_k`, `id_j`, `id_i`). Using the function `erce::lsa_weights()` we cna create the scaled survey weights for multilevel models. This function creates four new variables

  - **wa1** and **wa2** are the normalized weights

  - **wb1** and **wb2** are the scaled weights to the effective sample size

]


--


.pull_r_50_t_080[


```r
# scaling survey weights for mixed models

library(dplyr)
data_model &lt;- erce::erce_2019_qa6 %&gt;%
              # remove meta data
              erce::remove_labels() %&gt;%
              dplyr::glimpse()
              # create common clustering variables
              mutate(id_k = as.numeric(as.factor(paste0(IDCNTRY, "_", STRATA)))) %&gt;%
              mutate(id_s = as.numeric(as.factor(paste0(IDCNTRY, "_", STRATA)))) %&gt;%
              mutate(id_j = as.numeric(as.factor(paste0(IDCNTRY, "_", IDSCHOOL)))) %&gt;%
              mutate(id_i = seq(1:nrow(.))) %&gt;%
              # scaling survey weights for mixed models
              erce::lsa_weights(.,
              id_i = 'id_i',
              id_j = 'id_j',
              id_k = 'id_k',
              wt = 'WT',
              wi = 'WI',
              wj = 'WJ' )
```

- To replicate the ERCE 2019 results included in presentations, national reports, and results reports, we need to use the weights scaled to to the effective sample size (wb1, wb2).

- In practical terms most of the results do not show differences between the normalized weights (wa1, wa2), and the effective sample size weights (wb1, wb2). Previous literature though, warn us that effective sample size weights tend to give better quality estimtates for variances and covariances (see Stapleton, 2008). In general, simulation studies tend to favour the survey weights scaled to the effective sample size, for several conditions (Bertolet, 2008).

- For a more detail discussion on this topic you can check Snijder &amp; Bosker (2012, p239) and Heck &amp; Scott (2020, p346).

- To view the code in plain text, you can review it in **Code 1.1** en `05_multinivel_codigos.rmd` y `05_multinivel_codigos.html`.


]

---






class: inverse split-two


background-image: url(img/background_02.jpeg)
background-size: 100%


.column[
.pull_l_50_1[

.text_180[
.bold_white[
&lt;br&gt;
Many thanks!
    ]
  ]
]

.pull_l_50_2[
.line_space_03[
.text_60[

*Carrasco, D., PhD*

*Centro de Medición MIDE UC,*

*Pontificia Universidad Católica de Chile*

https://dacarras.github.io/
    ]
    ]
  ]
]








.column[

.text_180[
.bold_white[
&lt;br&gt;
Referencias
  ]
]

.text_60[
.french[

Bailey, P., Kelley, C., &amp; Nguyen, T. (2019). Introduction to Weighted Mixed-Effects Models With WeMix. https://cran.r-project.org/web/packages/WeMix/vignettes/Introduction_to_Mixed_Effects_Models_With_WeMix.pdf

Bertolet, M. (2008). To weight or not to weight? Incorporating sampling desing into model-based analyses. Carnegie Mellon University.

Enders, C. K., &amp; Tofighi, D. (2007). Centering predictor variables in cross-sectional multilevel models: a new look at an old issue. Psychological Methods, 12(2), 121–138. https://doi.org/10.1037/1082-989X.12.2.121

Heck, R. H., &amp; Thomas, S. L. (2020). An Introduction to Multilevel Modeling Techniques (4th ed.). Routledge.

Heeringa, S. G., West, B., &amp; Berglund, P. A. (2009). Applied Survey Data Analysis. Boca Raton, London, New York: Taylor &amp; Francis Group.

Geiser, C. (2012). Data Analysis with Mplus. The Guilford Press.

Snijders, T. A. B., &amp; Bosker, R. J. (2012). Multilevel Analysis (2nd ed.). SAGE Publications Ltd.

Stapleton, L. M. (2013). Incorporating Sampling Weights into Single- and Multilevel Analyses. In L. Rutkowski, M. von Davier, &amp; D. Rutkowski (Eds.), Handbook of International Large scale Assessment: background, technical issues, and methods of data analysis (pp. 363–388). Chapman and Hall/CRC.

Stapleton, L. M. (2006). An Assessment of Practical Solutions for Structural Equation Modeling with Complex Sample Data. Structural Equation Modeling: A Multidisciplinary Journal, 13(1), 28–58. http://doi.org/10.1207/s15328007sem1301_2

Stapleton, L. M. (2008). Variance Estimation Using Replication Methods in Structural Equation Modeling With Complex Sample Data. Structural Equation Modeling: A Multidisciplinary Journal, 15(2), 183–210. http://doi.org/10.1080/10705510801922316

Rights, J. D., Preacher, K. J., &amp; Cole, D. A. (2019). The danger of conflating level‐specific effects of control variables when primary interest lies in level‐2 effects. British Journal of Mathematical and Statistical Psychology, 4, bmsp.12194. https://doi.org/10.1111/bmsp.12194

West, B. T., Welch, K. B., &amp; Galecki, A. T. (2014). Linear Mixed Models: A Practical Guide Using Statistical Software (2nd ed.). Chapman and Hall/CRC.


  ] 
 ]
]









    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"slideNumberFormat": "%current%",
"countIncrementalSlides": true,
"ratio": "16:9",
"navigation": {
"scroll": true
}
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
